name: .NET Core

on:
  push:
    branches: 
      - master
      - features/try-github-actions

jobs:
  build:
    env:
      VERSION_MAJOR: 0
      VERSION_MINOR: 2
      VERSION_PATCH: 22
      BUILD_BUILDNUMBER: ${{env.VERSION_MAJOR}}.${{env.VERSION_MINOR}}.${{env.VERSION_PATCH}}.0
      BUILDCONFIGURATION: 'Release'
      JQM_PACKAGENAME: JamesQMurphy.Web.${{env.BUILD_BUILDNUMBER}}.zip
      JQM_CLOUDFORMATIONFILENAME: '*.yaml'
      JQM_TOOLINSTALLDIR: build/bin
      JQM_COMPAREBRANCH: master
      JQM_VERSIONFILE: build/azure-pipelines.yml
      JQM_GITTAGNAME: v${{env.BUILD_BUILDNUMBER}}      

    runs-on: ubuntu-latest

    steps:
    - name: Checkout Action
      uses: actions/checkout@v1
      
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.2.108

    - name: Print environment variables
      run: printenv

    - name: Install Amazon.Lambda.Tools
      run: dotnet tool install Amazon.Lambda.Tools --tool-path $JQM_TOOLINSTALLDIR

    - name: Run dotnet-lambda package
      run: ./dotnet-lambda package -c $BUILDCONFIGURATION -pl $GITHUB_WORKSPACE/src/JamesQMurphy.Web -o $GITHUB_WORKSPACE/a/JamesQMurphy.Web --msbuild-parameters "--self-contained true --runtime rhel-x64"
      working-directory: $JQM_TOOLINSTALLDIR
